<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYçš„æš´å¯Œç®—æ³•</title>
    <style>
 * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "å¾®è½¯é›…é»‘", "PingFang SC", sans-serif;
    transition: all 0.3s ease;
}
body {
    background: url('https://files.imagetourl.net/uploads/1766590822156-ac86b27a-1868-4085-9543-b97db5245e65.jpeg') no-repeat center center fixed;
    background-size: cover;
    padding: 5px;
    position: relative;
    max-width: 480px;
    margin: 0 auto;
}
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.85);
    z-index: -1;
}

.card {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 20px;
    padding: 16px;
    box-shadow: 0 8px 24px rgba(236, 72, 153, 0.12);
    margin: 8px;
    border: 1px solid #fce4ec;
}

.main-title {
    background: linear-gradient(135deg, #ec4899, #8b5cf6);
    color: white;
    border-radius: 16px;
    padding: 16px 20px;
    font-size: 18px;
    margin-bottom: 16px;
    font-weight: bold;
    text-align: center;
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.25);
    letter-spacing: 1px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.algorithm-select-section {
    margin-bottom: 16px;
    padding: 16px;
    background: #fdf2f8;
    border-radius: 16px;
    border-left: 4px solid #ec4899;
    animation: fadeIn 0.5s ease;
}
.select-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}
.select-icon {
    font-size: 20px;
    margin-right: 10px;
    color: #ec4899;
}
.select-title {
    font-size: 15px;
    font-weight: 600;
    color: #2d3748;
}
.algorithm-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #fce4ec;
    border-radius: 12px;
    font-size: 14px;
    background: white;
    color: #333;
    font-weight: 500;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ec4899' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 18px;
}
.algorithm-select:focus {
    outline: none;
    border-color-color: #ec4899;
    box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.15);
}

.type-select-section {
    margin-bottom: 16px;
    padding: 16px;
    background: #f0f9ff;
    border-radius: 16px;
    border-left: 4px solid #3b82f6;
    animation: fadeIn 0.5s ease 0.1s both;
}
.type-select-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}
.type-select-icon {
    font-size: 20px;
    margin-right: 10px;
    color: #3b82f6;
}
.type-select-title {
    font-size: 15px;
    font-weight: 600;
    color: #2d3748;
}
.type-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #bae6fd;
    border-radius: 12px;
    font-size: 14px;
    background: white;
    color: #333;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 18px;
}
.type-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
}

.current-algo-display {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    border: 2px solid #f0e7ff;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);
    animation: fadeIn 0.5s ease 0.2s both;
}
.current-algo-title {
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.current-algo-name {
    font-size: 16px;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 10px;
}
.confidence-badge {
    display: inline-block;
    padding: 5px 10px;
    background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
    color: white;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(236, 72, 153, 0.2);
}
.accuracy-display {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}
.accuracy-label {
    font-size: 13px;
    color: #666;
}
.accuracy-value {
    font-size: 16px;
    font-weight: 600;
    color: #ec4899;
}

.smart-prediction-card {
    background: white;
    border-radius: 20px;
    padding: 0;
    margin-bottom: 20px;
    border: 1px solid #fce4ec;
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.1);
    overflow: hidden;
    animation: slideUp 0.6s ease;
}

.smart-prediction-header {
    background: linear-gradient(135deg, #8b5cf6, #ec4899);
    color: white;
    border-radius: 20px 20px 0 0;
    padding: 16px 20px;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 8px rgba(139, 92, 246, 0.2);
}

.smart-prediction-content {
    padding: 20px;
}

.prediction-line {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #fef7fb;
}

.prediction-line:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.prediction-label {
    font-size: 14px;
    color: #64748b;
    margin-bottom: 6px;
    font-weight: 500;
}

.prediction-value {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
}

.prediction-combo {
    color: #059669;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(5, 150, 105, 0.1);
    animation: pulse 2s infinite;
}

.kill-group {
    color: #dc2626;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(220, 38, 38, 0.1);
}

/* cyç®—æ³•ä¸“ç”¨æ˜¾ç¤ºåŒºåŸŸ */
.buyvegetables-result {
    background: #fdf2f8;
    border: 2px solid #ec4899;
    border-radius: 16px;
    padding: 20px;
    margin-top: 20px;
    display: none;
    animation: fadeIn 0.5s ease;
}

.buyvegetables-title {
    font-weight: 700;
    font-size: 16px;
    color: #be185d;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.buyvegetables-combo {
    font-size: 22px;
    font-weight: 700;
    color: #059669;
    text-align: center;
    margin: 15px 0;
    padding: 16px;
    background: white;
    border-radius: 12px;
    border: 1px solid #10b981;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
    animation: pulse 2s infinite;
}

/* ç‰¹ç æ¨èåŒºåŸŸ */
.special-code-section {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 16px;
    padding: 20px;
    margin-top: 20px;
    animation: fadeIn 0.5s ease 0.3s both;
}

.special-code-title {
    font-weight: 700;
    font-size: 16px;
    color: #0369a1;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.special-codes-display {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
}

.special-code-item {
    padding: 10px 18px;
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    border: 2px solid #10b981;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 700;
    color: #065f46;
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
    transition: all 0.3s ease;
    min-width: 60px;
    text-align: center;
}

.special-code-item:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
}

.code-reason {
    font-size: 14px;
    color: #475569;
    line-height: 1.6;
    padding: 12px;
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.code-reason strong {
    color: #1e293b;
}

/* æŒ‰é’®æ ·å¼ */
.btn-group {
    margin-bottom: 16px;
    display: flex;
    gap: 12px;
}

.btn {
    padding: 14px 20px;
    border: none;
    border-radius: 16px;
    font-size: 15px;

    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex: 1;
    position: relative;
    overflow: hidden;
}
.btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: all 0.6s ease;
}
.btn:hover::after {
    left: 100%;
}
.btn-primary {
    background: linear-gradient(135deg, #ec4899, #8b5cf6);
    color: white;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}
.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(139, 92, 246, 0.4);
}
.btn-primary:active {
    transform: translateY(0);
}

.btn-secondary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}
.btn-secondary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4);
}

.btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}
.btn-success:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4);
}

.refresh-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 18px;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.3s ease;
}
.refresh-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(180deg);
}

/* ä¿®æ”¹è¡¨æ ¼æ ·å¼ */
.detail-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-radius: 12px;
    overflow: hidden;
    background-color: white;
}
.detail-table th, .detail-table td {
    border: 1px solid #f0f0f0;
    padding: 10px 8px;
    text-align: center;
    line-height: 1.5;
    font-weight: normal;
}
.detail-table th {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    padding: 12px;
    color: #0369a1;
    font-weight: 600;
}

/* å‘½ä¸­é¢œè‰² */
.hit-color {
    background: linear-gradient(135deg, #fef7fb, #fce7f3) !important;
    color: #be185d !important;
    font-weight: 600;
}

.detail-container { 
    width: 100%; 
    margin-top: 16px;
    margin-bottom: 12px;
    animation: fadeIn 0.5s ease 0.4s both;
}

.rule-info {
    font-size: 12px;
    color: #666;
    line-height: 1.6;
    padding: 12px;
    background: white;
    border-radius: 12px;
    border: 1px solid #f0f0f0;
    margin-top: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.rule-highlight {
    color: #ec4899;
    font-weight: 600;
}

/* èƒœç‡ç»Ÿè®¡åŒºåŸŸ */
.stats-section {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-top: 16px;
    border: 1px solid #f0e7ff;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);
    animation: fadeIn 0.5s ease 0.5s both;
}

.stats-title {
    font-size: 15px;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.stats-icon {
    font-size: 18px;
    color: #8b5cf6;
}

.stats-content {
    font-size: 18px;
    color: #ec4899;
    font-weight: 700;
}

.stats-detail {
    font-size: 13px;
    color: #666;
    margin-top: 8px;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #fce4ec;
    border-top: 3px solid #ec4899;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* å¼¹çª—æ ·å¼ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    background: white;
    border-radius: 24px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 12px 36px rgba(236, 72, 153, 0.25);
    animation: slideUp 0.4s ease-out;
    overflow: hidden;
    border: 1px solid #fce4ec;
}

.modal-header {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 24px;
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    border-bottom: 1px solid #fbbf24;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.modal-body {
    padding: 24px;
}

/* æ–°å¢å¼ºåŒ–å¼¹çª—æ ·å¼ */
.method-select {
    margin-bottom: 24px;
}

.method-title {
    font-size: 16px;
    font-weight: 600;
    color: #475569;
    margin-bottom: 12px;
}

.method-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.method-option {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #fdf2f8;
    border: 2px solid #fce4ec;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
}
.method-option:hover {
    background: #fef7fb;
    border-color: #ec4899;
    transform: translateY(-2px);
}

.method-option input[type="radio"] {
    margin-right: 12px;
    width: 20px;
    height: 20px;
    accent-color: #ec4899;
}

.method-name {
    font-weight: 600;
    color: #1e293b;
    margin-right: 12px;
    font-size: 15px;
}

.method-desc {
    font-size: 13px;
    color: #64748b;
}

.analysis-process {
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #e2e8f0;
}

.step {
    display: flex;
    align-items: flex-start;
    margin-bottom: 16px;
}

.step:last-child {
    margin-bottom: 0;
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-radius: 50%;
    font-size: 14px;
    font-weight: 600;
    margin-right: 12px;
    flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
}

.step-text {
    font-size: 14px;
    color: #475569;
    line-height: 1.6;
}

.calculate-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    position: relative;
    overflow: hidden;
}
.calculate-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: all 0.6s ease;
}
.calculate-btn:hover::after {
    left: 100%;
}
.calculate-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
}

.result-display {
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    border: 2px solid #10b981;
    border-radius: 16px;
    padding: 20px;
    margin-top: 20px;
    animation: fadeIn 0.5s ease;
}

.final-result {
    text-align: center;
    margin-bottom: 16px;
}

.result-label {
    font-size: 15px;
    color: #065f46;
    margin-bottom: 12px;
    font-weight: 600;
}

.result-groups {
    font-size: 24px;
    font-weight: 700;
    color: #065f46;
    padding: 16px;
    background: white;;
    border-radius: 12px;
    border: 1px solid #10b981;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
}

.result-explanation {
    font-size: 14px;
    color: #047857;
    text-align: center;
    line-height: 1.6;
    padding-top: 12px;
    border-top: 1px solid rgba(16, 185, 129, 0.3);
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 375px) {
    .btn-group {
        flex-direction: column;
        gap: 10px;
    }
    .special-code-item {
        min-width: 50px;
        padding: 8px 14px;
        font-size: 14px;
    }
    .main-title {
        font-size: 16px;
        padding: 14px 16px;
    }
    .smart-prediction-header {
        font-size: 16px;
        padding: 14px 16px;
    }
}

    </style>
</head>
<body>
    <div class="card">
        <div class="main-title" id="main-title">cyé¢„æµ‹æ¨¡å‹</div>
        
        <div class="algorithm-select-section" id="algorithm-select-section">
            <div class="select-header">
                <div class="select-icon">ğŸ“Š</div>
                <div class="select-title">é€‰æ‹©ç®—æ³•</div>
            </div>
            <select class="algorithm-select" id="algorithm-select">
                <option value="classic">æ— åŒç®—æ³•</option>
                <option value="hotcold">ä¸ƒå°‘ç®—æ³•</option>
                <option value="dongsnow">å¦‚çƒŸåˆ†æ</option>
                <option value="wave">å†°ç³–åˆ†æ</option>
                <option value="fibo">æ˜çš‡å¹½å¥‡</option>
                <option value="extreme">æ°´ä¸Šæ— åŒ</option>
                <option value="stable">ç‰©æ˜¯äººéç®—æ³•</option>
                <option value="probability">ä¼å…­ä¸ƒç®—æ³•</option>
                <option value="trend">ç¾å›½æ€»ç»Ÿç®—æ³•</option>
                <option value="seventyseven">åå…«ä»£è¨€ç®—æ³•</option>
                <option value="kacblic">æš´é¾™ç®—æ³•</option>
                <option value="bayesian" selected>æ—¶é—´ç®—æ³•</option>
                <option value="markov">æ˜ç«ç®—æ³•</option>
                <option value="fourier">é˜¿æ³¢ç½—ç®—æ³•</option>
                <option value="chaos">å°å·æ–—ç½—ç®—æ³•</option>
                <option value="buyvegetables">cyç®—æ³•</option>
            </select>
        </div>
        
        <!-- ç±»å‹é€‰æ‹©å™¨ -->
        <div class="type-select-section" id="type-select-section">
            <div class="type-select-header">
                <div class="type-select-icon">ğŸ”„</div>
                <div class="type-select-title">é€‰æ‹©åŒ¹é…ç±»å‹</div>
            </div>
            <select class="type-select" id="type-select">
                <option value="double" selected>åŒç»„æ¨¡å¼</option>
                <option value="kill">æ€ç»„åˆæ¨¡å¼</option>
            </select>
            <div class="rule-info">
                <div id="double-rule-info" style="display: block;">
                    <span class="rule-highlight">åŒç»„åŒ¹é…è§„åˆ™ï¼š</span><br>
                    â€¢ æ€å°å• â†’ åŒç»„ï¼šå¤§å•+å¤§åŒ<br>
                    â€¢ æ€å¤§å• â†’ åŒç»„ï¼šå°åŒ+å¤§åŒ<br>
                    â€¢ æ€å°åŒ â†’ åŒç»„ï¼šå°å•+å¤§å•<br>
                    â€¢ æ€å¤§åŒ â†’ åŒç»„ï¼šå°å•+å°åŒ
                </div>
                <div id="kill-rule-info" style="display: none;">
                    <span class="rule-highlight">æ€ç»„åˆåŒ¹é…è§„åˆ™ï¼š</span><br>
                    â€¢ æ€å¤§å• â†’ å¤§åŒ+å° æˆ– å°å•+åŒ<br>
                    â€¢ æ€å¤§åŒ â†’ å¤§å•+å° æˆ– å°åŒ+å•<br>
                    â€¢ æ€å°åŒ â†’ å°å•+å¤§ æˆ– å¤§åŒ+å•<br>
                    â€¢ æ€å°å• â†’ å°åŒ+å¤§ æˆ– å¤§å•+åŒ
                </div>
            </div>
        </div>
        
        <div class="smart-prediction-card" id="smart-prediction-card">
            <div class="smart-prediction-header">
                <span>ğŸ¯ AIé¢„æµ‹åˆ†æ</span>
                <button class="refresh-btn" id="header-refresh-btn" title="åˆ·æ–°æ•°æ®">
                    ğŸ”„
                </button>
            </div>
            <div class="smart-prediction-content">
                <div class="prediction-line">
                    <div class="prediction-label">ä¸‹ä¸€æœŸ</div>
                    <div class="prediction-value" id="smart-next-period">--</div>
                </div>
                
                <div class="prediction-line">
                    <div class="prediction-label">é¢„æµ‹ç»„åˆ</div>
                    <div class="prediction-value">
                        <span class="prediction-combo" id="smart-prediction-combo">--</span>
                        <span style="margin: 0 15px;">|</span>
                        <span class="prediction-label">æ€ç»„ï¼š</span>
                        <span class="kill-group" id="smart-kill-group">--</span>
                    </div>
                </div>
                
                <!-- cyç®—æ³•ä¸“ç”¨æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="buyvegetables-result" id="buyvegetables-result">
                    <div class="buyvegetables-title">
                        <span>ğŸ‘</span>
                        <span>cyç®—æ³•é¢„æµ‹ç»“æœ</span>
                    </div>
                    <div class="buyvegetables-combo" id="buyvegetables-combo">--</div>
                </div>
                
                <!-- å…¶ä»–ç®—æ³•ç‰¹ç æ¨èåŒºåŸŸ -->
                <div class="special-code-section" id="special-code-section">
                    <div class="special-code-title">
                        <span>ğŸ”¢</span>
                        <span>æ™ºèƒ½ç‰¹ç æ¨èï¼ˆåŸºäºé¢„æµ‹ç»„åˆç”Ÿæˆï¼‰</span>
                    </div>
                    
                    <div class="special-codes-display" id="special-codes-display">
                        <div class="special-code-item">--</div>
                        <div class="special-code-item">--</div>
                        <div class="special-code-item">--</div>
                        <div class="special-code-item">--</div>
                        <div class="special-code-item">--</div>
                    </div>
                    
                    <div class="code-reason" id="special-code-reason">
                        <strong>æ¨èç†ç”±ï¼š</strong>
                        <span id="reason-text">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="current-algo-display">
            <div class="current-algo-title">
                <span>å½“å‰ä½¿ç”¨ç®—æ³•</span>
                <span class="confidence-badge" id="confidence-badge">--%</span>
            </div>
            <div class="current-algo-name" id="current-algo-name">æ— åŒç®—æ³•</div>
            <div class="accuracy-display">
                <div class="accuracy-label">ç®—æ³•ç½®ä¿¡åº¦ï¼š</div>
                <div class="accuracy-value" id="accuracy-value">--%</div>
            </div>
        </div>

        <!-- æ™®é€šç®—æ³•æŒ‰é’®ç»„ -->
        <div class="btn-group" id="normal-btn-group">
            <button class="btn btn-primary" id="analyze-btn">
                <span class="loading" id="analyze-loading" style="display:none;"></span>
                <span id="analyze-text">ğŸ” å¼€å§‹é€æœŸåˆ†æ</span>
            </button>
            <button class="btn btn-secondary" id="refresh-data-btn">
                <span class="loading" id="refresh-loading" style="display:none;"></span>
                <span id="refresh-text">ğŸ”„ åˆ·æ–°æ•°æ®</span>
            </button>
            <button class="btn btn-success" id="enhance-double-btn">
                <span>âœ¨</span>
                <span id="enhance-text">å¼ºåŒ–åŒç»„</span>
            </button>
        </div>

        <!-- cyç®—æ³•æŒ‰é’®ç»„ -->
        <div class="btn-group" id="buyvegetables-btn-group" style="display: none;">
            <button class="btn btn-primary" id="buyvegetables-refresh-btn" style="flex: 1;">
                <span class="loading" id="bv-refresh-loading" style="display:none;"></span>
                <span id="bv-refresh-text">ğŸ”„ åˆ·æ–°cyç®—æ³•æ•°æ®</span>
            </button>
        </div>

        <!-- è¡¨æ ¼åŒºåŸŸï¼ˆXXç®—æ³•æ—¶ä¸æ˜¾ç¤ºï¼‰ -->
        <div class="detail-container" id="full-mode-table">
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>å¼€å¥–</th>
                        <th>æ€ç»„</th>
                        <th id="combo-header">åŒç»„</th>
                        <th>åˆ¤æ–­</th>
                    </tr>
                </thead>
                <tbody id="detail-tbody">
                    <tr>
                        <td colspan="5" style="color: #999;">ç‚¹å‡»åˆ†æåå±•ç¤ºæ˜ç»†æ•°æ®</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- èƒœç‡ç»Ÿè®¡åŒºåŸŸ -->
            <div class="stats-section" id="stats-section" style="display: none;">
                <div class="stats-title">
                    <span class="stats-icon">ğŸ“ˆ</span>
                    <span>èƒœç‡ç»Ÿè®¡</span>
                </div>
                <div class="stats-content" id="stats-content">--</div>
                <div class="stats-detail" id="stats-detail">æ€ä¸­æˆ–ç»„ä¸­éƒ½ç®—ä¸­</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let selectedAlgorithm = 'bayesian';
        let selectedType = 'double';
        let allLotteryData = [];
        let detailRecords = [];
        let totalHitRateStats = initTotalHitRateStats();
        let killGroupCache = {};
        let killGroupHistory = { last: '', count: 0 };
        let dataCache = null;
        let nextPeriod = 1;
        const BASE_TIME = new Date('2025-01-01 00:00:00').getTime();
        const MAX_SAME_KILL = 3;
        const DISPLAY_COUNT = 20;

        // ==================== ç®—æ³•åç§°æ˜ å°„ ====================
        function getAlgorithmName(algoId) {
            const names = {
                'classic': 'æ— åŒç®—æ³•',
                'hotcold': 'ä¸ƒå°‘ç®—æ³•',
                'dongsnow': 'å¦‚çƒŸåˆ†æ',
                'wave': 'å†°ç³–åˆ†æ',
                'fibo': 'æ˜çš‡å¹½å¥‡',
                'extreme': 'æ°´ä¸Šæ— åŒ',
                'stable': 'ç‰©æ˜¯äººéç®—æ³•',
                'probability': 'ä¼å…­ä¸ƒç®—æ³•',
                'trend': 'ç¾å›½æ€»ç»Ÿç®—æ³•',
                'seventyseven': 'åå…«ä»£è¨€ç®—æ³•',
                'kacblic': 'æ—¶é—´ç®—æ³•',
                'bayesian': 'æ˜ç«ç®—æ³•',
                'markov': 'é˜¿æ³¢ç½—ç®—æ³•',
                'fourier': 'å°å·æ–—ç½—ç®—æ³•',
                'chaos': 'æš´é¾™ç®—æ³•',
                'buyvegetables': 'cyç®—æ³•'
            };
            return names[algoId] || algoId;
        }

        // ==================== åˆå§‹åŒ–å‡½æ•° ====================
        function initTotalHitRateStats() {
            const stats = {};
            const algos = [
                'classic','hotcold','dongsnow','wave','fibo',
                'extreme','stable','probability','trend','seventyseven',
                'kacblic','bayesian','markov','fourier','chaos'
            ];
            algos.forEach(algo => stats[algo] = { hit: 0, total: 0 });
            const saved = localStorage.getItem('totalHitRateStats');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    algos.forEach(algo => {
                        if (!parsed[algo]) parsed[algo] = { hit: 0, total: 0 };
                    });
                    return parsed;
                } catch(e) {
                    return stats;
                }
            }
            return stats;
        }

        // ==================== ç®—æ³•é€‰æ‹©ç®¡ç† ====================
        function selectAlgorithmFromDropdown(algoId) {
            selectedAlgorithm = algoId;
            killGroupCache = {};
            killGroupHistory = { last: '', count: 0 };
            
            // æ˜¾ç¤º/éšè—ç›¸å…³åŒºåŸŸ
            const bvResult = document.getElementById('buyvegetables-result');
            const specialCodeSection = document.getElementById('special-code-section');
            const fullModeTable = document.getElementById('full-mode-table');
            const normalBtnGroup = document.getElementById('normal-btn-group');
            const buyvegetablesBtnGroup = document.getElementById('buyvegetables-btn-group');
            
            if (algoId === 'buyvegetables') {
                bvResult.style.display = 'block';
                specialCodeSection.style.display = 'none';
                fullModeTable.style.display = 'none';
                normalBtnGroup.style.display = 'none';
                buyvegetablesBtnGroup.style.display = 'flex';
                
                // æ¸…ç©ºåŸæœ‰é¢„æµ‹æ˜¾ç¤º
                document.getElementById('smart-prediction-combo').textContent = '--';
                document.getElementById('smart-kill-group').textContent = '--';
                
                // ç›´æ¥åŠ è½½æ•°æ®å¹¶æ˜¾ç¤ºcyç®—æ³•ç»“æœ
                loadDataAndShowBuyVegetables();
            } else {
                bvResult.style.display = 'none';
                specialCodeSection.style.display = 'block';
                fullModeTable.style.display = 'block';
                normalBtnGroup.style.display = 'flex';
                buyvegetablesBtnGroup.style.display = 'none';
            }
            
            updateCurrentAlgorithmDisplay(algoId, null);
            
            if (detailRecords.length > 0 && algoId !== 'buyvegetables') {
                analyzeData();
            }
        }

        function selectTypeFromDropdown(typeId) {
    selectedType = typeId;
    
    if (typeId === 'double') {
        document.getElementById('double-rule-info').style.display = 'block';
        document.getElementById('kill-rule-info').style.display = 'none';
        document.getElementById('combo-header').textContent = 'åŒç»„';
    } else {
        document.getElementById('double-rule-info').style.display = 'none';
        document.getElementById('kill-rule-info').style.display = 'block';
        document.getElementById('combo-header').textContent = 'æ€ç»„åˆ';
    }
    
    if (detailRecords.length > 0 && selectedAlgorithm !== 'buyvegetables') {
        analyzeData();
    }
}

function updateCurrentAlgorithmDisplay(algoId, rate) {
    const algoName = getAlgorithmName(algoId);
    
    if (algoId === 'buyvegetables') {
        document.getElementById('current-algo-name').textContent = algoName;
        document.getElementById('confidence-badge').textContent = '--%';
        document.getElementById('accuracy-value').textContent = '--%';
    } else {
        const stats = totalHitRateStats[algoId] || { hit: 0, total: 0 };
        const currentRate = rate !== null ? rate : (stats.total > 0 ? Math.round((stats.hit / stats.total) * 100) : 0);
        
        document.getElementById('current-algo-name').textContent = algoName;
        document.getElementById('confidence-badge').textContent = `${currentRate}%`;
        document.getElementById('accuracy-value').textContent = `${currentRate}%`;
    }
}

// ==================== å¼ºåŒ–åŒç»„åŠŸèƒ½ï¼ˆä¸‰é€‰ä¸€æ¨¡å¼ï¼‰ ====================
function showEnhanceDouble() {
    // è·å–å½“å‰æ€ç»„
    const killGroup = document.getElementById('smart-kill-group').textContent;
    
    if (killGroup === '--' || killGroup === '') {
        alert('è¯·å…ˆè¿›è¡Œé¢„æµ‹åˆ†æï¼Œè·å–æ€ç»„ä¿¡æ¯ï¼');
        return;
    }
    
    if (allLotteryData.length < 10) {
        alert('å†å²æ•°æ®ä¸è¶³10æœŸï¼Œæ— æ³•è¿›è¡Œå¼ºåŒ–åˆ†æï¼');
        return;
    }
    
    // åˆ›å»ºå¼¹çª—å†…å®¹
    const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                ğŸ¯ ä¸‰é€‰ä¸€å¼ºåŒ–åŒç»„
            </div>
            <div class="modal-body">
                <div class="method-select">
                    <div class="method-title">é€‰æ‹©å¼ºåŒ–æ–¹æ³•ï¼š</div>
                    <div class="method-options">
                        <label class="method-option">
                            <input type="radio" name="enhance-method" value="algorithm1" checked>
                            <span class="method-name">ç®—æ³•ä¸€</span>
                            <span class="method-desc"></span>
                        </label>
                        <label class="method-option">
                            <input type="radio" name="enhance-method" value="algorithm2">
                            <span class="method-name">ç®—æ³•äºŒ</span>
                            <span class="method-desc"></span>
                        </label>
                        <label class="method-option">
                            <input type="radio" name="enhance-method" value="history">
                            <span class="method-name">å†å²æ’é™¤</span>
                            <span class="method-desc"></span>
                        </label>
                    </div>
                </div>
                
                <div class="analysis-process">
                    <div class="step">
                        <span class="step-number">1</span>
                        <span class="step-text">ç®—æ³•æ€ç»„ï¼š<strong>${killGroup}</strong></span>
                    </div>
                    <div class="step" id="method-step">
                        <span class="step-number">2</span>
                        <span class="step-text">ç­‰å¾…é€‰æ‹©å¼ºåŒ–æ–¹æ³•...</span>
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <span class="step-text">æœ€ç»ˆåŒç»„ï¼š<strong id="final-groups">ç­‰å¾…è®¡ç®—</strong></span>
                    </div>
                </div>
                
                <button class="calculate-btn" id="calculate-btn">å¼€å§‹è®¡ç®—</button>
                
                <div class="result-display" id="result-display" style="display: none;">
                    <div class="final-result">
                        <div class="result-label">æ¨èè´­ä¹°ç»„åˆï¼š</div>
                        <div class="result-groups" id="result-groups"></div>
                    </div>
                    <div class="result-explanation" id="result-explanation"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close-btn" id="modal-close-btn">å…³é—­</button>
            </div>
        </div>
    `;
    
    // æ˜¾ç¤ºå¼¹çª—
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    
    // ç»‘å®šäº‹ä»¶
    setupEnhanceModalEvents(modal, killGroup);
}

// è®¾ç½®å¼¹çª—äº‹ä»¶
function setupEnhanceModalEvents(modal, killGroup) {
    // è®¡ç®—æ–¹æ³•é€‰æ‹©
    modal.querySelector('#calculate-btn').addEventListener('click', function() {
        calculateEnhanceResult(modal, killGroup);
    });
    
    // æ–¹æ³•é€‰æ‹©å˜åŒ–
    const methodRadios = modal.querySelectorAll('input[name="enhance-method"]');
    methodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            updateMethodStep(modal, this.value);
        });
    });
    
    // åˆå§‹æ›´æ–°æ–¹æ³•æ­¥éª¤
    const selectedMethod = modal.querySelector('input[name="enhance-method"]:checked').value;
    updateMethodStep(modal, selectedMethod);
    
    // å…³é—­æŒ‰é’®
    modal.querySelector('#modal-close-btn').addEventListener('click', function() {
        document.body.removeChild(modal);
    });
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
}

// æ›´æ–°æ–¹æ³•æ­¥éª¤æ˜¾ç¤º
function updateMethodStep(modal, method) {
    const methodStep = modal.querySelector('#method-step .step-text');
    const methodNames = {
        'algorithm1': 'ç®—æ³•ä¸€',
        'algorithm2': 'ç®—æ³•äºŒ', 
        'history': 'å†å²æ’é™¤'
    };
    
    methodStep.innerHTML = `<strong>${methodNames[method]}</strong>ï¼ˆå†æ’é™¤ä¸€ç»„ï¼‰`;
}

// è®¡ç®—å¼ºåŒ–ç»“æœ
function calculateEnhanceResult(modal, killGroup) {
    const selectedMethod = modal.querySelector('input[name="enhance-method"]:checked').value;
    const recentData = allLotteryData.slice(-10);
    const recentSums = recentData.map(d => d.sum);
    const totalSum = recentSums.reduce((a, b) => a + b, 0);
    
    let secondKillGroup = '';
    let explanation = '';
    
    // æ‰€æœ‰ç»„åˆ
    const allGroups = ['å°åŒ', 'å°å•', 'å¤§å•', 'å¤§åŒ'];
    const remainingGroups = allGroups.filter(group => group !== killGroup);
    
    // æ ¹æ®é€‰æ‹©çš„æ–¹æ³•è®¡ç®—ç¬¬äºŒæ€ç»„
    if (selectedMethod === 'algorithm1') {
        // ç®—æ³•ä¸€ï¼šæ€»æ•° Ã· 1.2457
        const calculation = totalSum / 1.2457;
        const integerValue = Math.round(calculation);
        
        // åˆ¤æ–­å¤§å°å•åŒ
        const size = integerValue <= 13 ? 'å°' : 'å¤§';
        const parity = integerValue % 2 === 0 ? 'åŒ' : 'å•';
        const predictedGroup = size + parity;
        
        // ç®—æ³•ä¸€æ€ç»„æ˜ å°„
        const algorithm1KillMap = {
            'å°åŒ': 'å¤§å•',
            'å°å•': 'å¤§åŒ', 
            'å¤§åŒ': 'å°å•',
            'å¤§å•': 'å°åŒ'
        };
        
        secondKillGroup = algorithm1KillMap[predictedGroup] || 'å¤§å•';
        explanation = `ç®—æ³•ä¸€è®¡ç®—ç»“æœï¼š${predictedGroup} â†’ æ’é™¤${secondKillGroup}`;
        
    } else if (selectedMethod === 'algorithm2') {
        // ç®—æ³•äºŒï¼šæ€»æ•° Ã· 1.1789 + 2
        const calculation = (totalSum / 1.1789) + 2;
        const integerValue = Math.round(calculation);
        
        // åˆ¤æ–­å¤§å°å•åŒ
        const size = integerValue <= 13 ? 'å°' : 'å¤§';
        const parity = integerValue % 2 === 0 ? 'åŒ' : 'å•';
        const predictedGroup = size + parity;
        
        // ç®—æ³•äºŒæ€ç»„æ˜ å°„
        const algorithm2KillMap = {
            'å°åŒ': 'å¤§å•',
            'å°å•': 'å¤§åŒ', 
            'å¤§åŒ': 'å°å•',
            'å¤§å•': 'å°åŒ'
        };
        
        secondKillGroup = algorithm2KillMap[predictedGroup] || 'å¤§å•';
        explanation = `ç®—æ³•äºŒè®¡ç®—ç»“æœï¼š${predictedGroup} â†’ æ’é™¤${secondKillGroup}`;
        
    } else if (selectedMethod === 'history') {
        // å†å²æ’é™¤æ³•ï¼šæ’é™¤æœ€è¿‘å‡ºç°æœ€å¤šçš„ç»„åˆ
        const countMap = { 'å°åŒ': 0, 'å°å•': 0, 'å¤§å•': 0, 'å¤§åŒ': 0 };
        recentData.forEach(item => {
            countMap[item.combo] = (countMap[item.combo] || 0) + 1;
        });
        
        // åœ¨å‰©ä½™ç»„åˆä¸­æ‰¾å‡ºç°æœ€å¤šçš„æ’é™¤
        let maxCount = 0;
        remainingGroups.forEach(group => {
            const count = countMap[group] || 0;
            if (count > maxCount) {
                maxCount = count;
                secondKillGroup = group;
            }
        });
        
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé»˜è®¤æ’é™¤ç¬¬ä¸€ä¸ª
        if (!secondKillGroup && remainingGroups.length > 0) {
            secondKillGroup = remainingGroups[0];
        }
        
        explanation = `å†å²æ’é™¤æ³•ï¼šæ’é™¤è¿‘æœŸå‡ºç°${maxCount}æ¬¡çš„${secondKillGroup}`;
    }
    
    // ç¡®ä¿ç¬¬äºŒæ€ç»„åœ¨å‰©ä½™ç»„åˆä¸­
    if (!remainingGroups.includes(secondKillGroup)) {
        secondKillGroup = remainingGroups[0] || 'å¤§å•';
    }
    
    // è®¡ç®—æœ€ç»ˆåŒç»„
    const finalGroups = remainingGroups.filter(group => group !== secondKillGroup);
    
    // æ›´æ–°æ˜¾ç¤º
    modal.querySelector('#final-groups').textContent = finalGroups.join(' + ');
    
    const resultDisplay = modal.querySelector('#result-display');
    resultDisplay.style.display = 'block';
    modal.querySelector('#result-groups').textContent = finalGroups.join(' + ');
    modal.querySelector('#result-explanation').textContent = `æ’é™¤${killGroup} + æ’é™¤${secondKillGroup}ï¼Œå‰©ä½™ä¸¤ç»„ä¸ºæ¨èè´­ä¹°ç»„åˆ`;
    
    // æ»šåŠ¨åˆ°ç»“æœ
    resultDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ==================== cyç®—æ³•å®ç° ====================
function getBuyVegetablesCombo(data) {
    if (data.length < 4) {
        return {
            combo: ['å¤§å•', 'å¤§åŒ'],
            error: 'æ•°æ®ä¸è¶³4æœŸ'
        };
    }
    
    try {
        // æ•°æ®æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼Œæœ€åä¸€æ¡æ˜¯æœ€æ–°
        const last4 = data.slice(-4);
        
        const period1 = last4[3].sum; // æœ€æ–°ä¸€æœŸ
        const period2 = last4[2].sum; // ç¬¬2æœŸ
        const period3 = last4[1].sum; // ç¬¬3æœŸ
        const period4 = last4[0].sum; // æœ€æ—©ä¸€æœŸ
        
        // è®¡ç®—ï¼š(ç¬¬2+3+4æœŸ) - ç¬¬1æœŸ
        const sum234 = period2 + period3 + period4;
        const calc = sum234 - period1;
        const absCalc = Math.abs(calc);
        
        // åå…­è¿›åˆ¶è½¬åè¿›åˆ¶
        const decimalValue = parseInt(absCalc.toString(), 16);
        
        // æ‹†åˆ†æ•°å­—
        const str = decimalValue.toString().padStart(2, '0');
        const num1 = parseInt(str[0]) || 0;
        const num2 = parseInt(str[1]) || 0;
        
        // æ¯”è¾ƒå¤§å°
        const smaller = Math.min(num1, num2);
        const larger = Math.max(num1, num2);
        
        // ç”ŸæˆåŒç»„
        const combo1 = (smaller < larger ? 'å°' : 'å¤§') + 
                      (smaller % 2 === 1 ? 'å•' : 'åŒ');
        const combo2 = (larger > smaller ? 'å¤§' : 'å°') + 
                      (larger % 2 === 1 ? 'å•' : 'åŒ');
        
        return {
            combo: [combo1, combo2],
            error: null
        };
        
    } catch (err) {
        console.error('cyç®—æ³•å¤±è´¥:', err);
        return {
            combo: ['å¤§å•', 'å¤§åŒ'],
            error: 'è®¡ç®—é”™è¯¯'
        };
    }
}

// ==================== åŠ è½½æ•°æ®å¹¶æ˜¾ç¤ºcyç®—æ³•ç»“æœ ====================
async function loadDataAndShowBuyVegetables() {
    const btn = document.getElementById('buyvegetables-refresh-btn');
    const loading = document.getElementById('bv-refresh-loading');
    const text = document.getElementById('bv-refresh-text');
    
    btn.disabled = true;
    text.textContent = 'åŠ è½½ä¸­...';
    loading.style.display = 'inline-block';
    
    try {
        await fetchAllData();
        
        if (allLotteryData.length === 0) {
            document.getElementById('buyvegetables-combo').textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
            return;
        }
        
        const bvResult = getBuyVegetablesCombo(allLotteryData);
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('smart-next-period').textContent = nextPeriod;
        document.getElementById('buyvegetables-combo').textContent = bvResult.combo.join(' + ');
        
        console.log('cyç®—æ³•ç»“æœ:', bvResult.combo.join(' + '));
        
    } catch (err) {
        console.error('cyç®—æ³•æ•°æ®åŠ è½½å¤±è´¥:', err);
        document.getElementById('buyvegetables-combo').textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
    } finally {
        btn.disabled = false;
        text.textContent = 'ğŸ”„ åˆ·æ–°cyç®—æ³•æ•°æ®';
        loading.style.display = 'none';
    }
}

// ==================== åŒ¹é…è§„åˆ™å‡½æ•° ====================
function getDoubleComboFromKillGroup(killGroup) {
    const fixedRuleMap = {
        'å°å•': ['å¤§å•', 'å¤§åŒ'],
        'å¤§å•': ['å°åŒ', 'å¤§åŒ'],
        'å°åŒ': ['å°å•', 'å¤§å•'],
        'å¤§åŒ': ['å°å•', 'å°åŒ']
    };
    return fixedRuleMap[killGroup] || ['å¤§å•', 'å¤§åŒ'];
}

function getKillComboFromKillGroup(killGroup) {
    const killComboMap = {
        'å¤§å•': ['å¤§åŒ+å°', 'å°å•+åŒ'],
        'å¤§åŒ': ['å¤§å•+å°', 'å°åŒ+å•'],
        'å°åŒ': ['å°å•+å¤§', 'å¤§åŒ+å•'],
        'å°å•': ['å°åŒ+å¤§', 'å¤§å•+åŒ']
    };
    
    const combos = killComboMap[killGroup] || ['å¤§å•+å¤§åŒ'];
    const randomIndex = Math.floor(Math.random() * combos.length);
    return [combos[randomIndex]];
}

function getComboFromKillGroup(killGroup) {
    if (selectedType === 'double') {
        return getDoubleComboFromKillGroup(killGroup);
    } else {
        return getKillComboFromKillGroup(killGroup);
    }
}

// ==================== æ•°æ®è·å– ====================
async function fetchAllData() {
    // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è·å–æ•°æ®
    dataCache = null;
    
    try {
        const API_URL = "http://dabaisf.com:666/index.php?s=yuce&id=11072";
        console.log('æ­£åœ¨è·å–æ•°æ®...');
        
        const res = await fetch(API_URL, {
            mode: 'cors',
            headers: { 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' }
        });

        if(!res.ok) throw new Error(`æ¥å£è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${res.status}`);
        const html = await res.text();
        const dom = new DOMParser().parseFromString(html, 'text/html');
        const data = [];

        dom.querySelectorAll('table').forEach(table => {
            table.querySelectorAll('tr').forEach((row, idx) => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 3) return;

                const period = cells[0].textContent.trim();
                const resultStr = cells[2].textContent.trim();
                if (!period || !resultStr) return;

                const sum = parseInt(resultStr.split('=').pop() || resultStr);
                if(isNaN(sum)) return;
                const size = sum <= 13 ? 'å°' : 'å¤§';
                const oddEven = sum % 2 === 1 ? 'å•' : 'åŒ';
                const combo = size + oddEven;

                const num1 = Math.floor(sum / 3);
                const num2 = Math.floor(sum / 3);
                const num3 = sum - num1 - num2;
                const formula = `${num1}+${num2}+${num3}=${sum}`;
                const time = new Date(BASE_TIME + parseInt(period) * 60 * 1000).toTimeString().slice(0,5);

                data.push({ period, time, formula, combo, sum: sum });
            });
        });

        allLotteryData = data.sort((a,b) => a.period.localeCompare(b.period));
        console.log('è§£æåˆ°æ•°æ®æ¡æ•°:', allLotteryData.length);
        
        if(allLotteryData.length > 0) {
            nextPeriod = parseInt(allLotteryData[allLotteryData.length-1].period) + 1;
            console.log('ä¸‹ä¸€æœŸ:', nextPeriod);
        }
        
        if(allLotteryData.length === 0) throw new Error("æœªè§£æåˆ°æœ‰æ•ˆå¼€å¥–æ•°æ®");
        
        dataCache = allLotteryData;
        return allLotteryData;
        
    } catch (err) {
        console.error('æ•°æ®è·å–å¤±è´¥:', err);
        allLotteryData = [];
        nextPeriod = 1;
        return allLotteryData;
    }
}

// ==================== ç‰¹ç æ¨èåŠŸèƒ½ ====================
function generateSpecialCodes(predictionCombos, historyData) {
    const codeMap = {
        'å¤§å•': [13, 15, 17, 19, 21, 23, 25, 27],
        'å°å•': [1, 3, 5, 7, 9, 11],
        'å¤§åŒ': [14, 16, 18, 20, 22, 24, 26],
        'å°åŒ': [2, 4, 6, 8, 10, 12]
    };
    
    let allCodes = [];
    let reasons = [];
    
    predictionCombos.forEach(combo => {
        if (codeMap[combo]) {
            const comboCodes = codeMap[combo];
            allCodes = allCodes.concat(comboCodes);
            reasons.push(`ä»${combo}ç»„åˆé€‰æ‹©æ ¸å¿ƒå·ç `);
        }
    });
    
    let selectedCodes = [...new Set(allCodes)].sort((a, b) => a - b);
    
    if (selectedCodes.length > 5) {
        const recentData = historyData.slice(0, Math.min(10, historyData.length));
        const recentSums = recentData.map(d => d.sum);
        const avgSum = recentSums.length > 0 ? 
            recentSums.reduce((a, b) => a + b, 0) / recentSums.length : 13.5;
        
        if (avgSum > 16) {
            selectedCodes = selectedCodes.filter(code => code >= 14);
            reasons.push('åŸºäºè¿‘æœŸå¤§å’Œå€¼è¶‹åŠ¿ï¼Œä¼˜é€‰å¤§å·ç ');
        } else if (avgSum < 11) {
            selectedCodes = selectedCodes.filter(code => code <= 12);
            reasons.push('åŸºäºè¿‘æœŸå°å’Œå€¼è¶‹åŠ¿ï¼Œä¼˜é€‰å°å·ç ');
        } else {
            const smallCodes = selectedCodes.filter(code => code <= 13);
            const bigCodes = selectedCodes.filter(code => code >= 14);
            
            let balancedCodes = [];
            if (smallCodes.length > 0 && bigCodes.length > 0) {
                balancedCodes = [
                    ...smallCodes.slice(0, 3),
                    ...bigCodes.slice(0, 2)
                ];
            } else {
                balancedCodes = selectedCodes.slice(0, 5);
            }
            
            selectedCodes = balancedCodes;
            reasons.push('åŸºäºå¹³è¡¡åˆ†å¸ƒåŸåˆ™é€‰æ‹©å·ç ');
        }
    }
    
    selectedCodes = selectedCodes.slice(0, 5);
    
    if (selectedCodes.length < 5) {
        const defaultCodes = [2, 4, 6, 8, 10];
        const needed = 5 - selectedCodes.length;
        const supplement = defaultCodes.filter(code => !selectedCodes.includes(code)).slice(0, needed);
        selectedCodes = [...selectedCodes, ...supplement];
        if (supplement.length > 0) {
            reasons.push('è¡¥å……ç³»ç»Ÿæ¨èå·ç ');
        }
    }
    
    return {
        codes: selectedCodes,
        reasons: reasons.join('ï¼›')
    };
}

// ==================== 77ç®—æ³• ====================
function getSeventySevenKillGroup(data) {
    if (data.length < 2) return 'å°å•';
    
    const last2 = data.slice(-2);
    let sum = 0;
    last2.forEach(item => {
        const formula = item.formula;
        const numbersPart = formula.split('=')[0];
        const numbers = numbersPart.split('+').map(n => parseFloat(n));
        
        if (numbers.length === 3) {
            const value = (numbers[0] + numbers[1]) / 2 + numbers[2] / 3;
            sum += value;
        }
    });
    
    const size = sum <= 13.5 ? 'å°' : 'å¤§';
    const oddEven = Math.round(sum) % 2 === 1 ? 'å•' : 'åŒ';
    const predictedCombo = size + oddEven;
    
    const killMap = {
        'å°åŒ': 'å¤§å•',
        'å°å•': 'å¤§åŒ',
        'å¤§åŒ': 'å°å•',
        'å¤§å•': 'å°åŒ'
    };
    
    return killMap[predictedCombo] || 'å°å•';
}

// ==================== æœŸå·ç®—æ³• ====================
async function getKacblicKillGroup(currentPeriod) {
    try {
        const currentIndex = allLotteryData.findIndex(item => item.period === currentPeriod);
        if (currentIndex <= 0) return 'å°åŒ';
        
        const prevData1 = allLotteryData[currentIndex - 1];
        const prevData2 = currentIndex >= 2 ? allLotteryData[currentIndex - 2] : prevData1;
        const prevData3 = currentIndex >= 3 ? allLotteryData[currentIndex - 3] : prevData2;
        
        const prevPeriod = prevData1.period;
        const prevSum = prevData1.sum;
        const prevSum2 = prevData2.sum;
        const prevSum3 = prevData3.sum;
        
        let periodSum = 0;
        for (let i = 0; i < prevPeriod.length; i++) {
            const digit = parseInt(prevPeriod[i]);
            if (!isNaN(digit)) {
                periodSum += digit;
                if ((i + 1) % 2 === 1) periodSum += 1;
            }
        }
        
        const lastDigit = prevSum % 10;
        const lastDigit2 = prevSum2 % 10;
        
        let result = (periodSum * 1.6) - (lastDigit * 2) + (lastDigit2 * 1);
        
        if (currentIndex >= 3) {
            const recentSum1 = prevSum;
            const recentSum2 = prevSum2;
            const recentSum3 = prevSum3;
            
            const trend1 = recentSum1 - recentSum2;
            const trend2 = recentSum2 - recentSum3;
            
            if (trend1 > 0 && trend2 > 0) result += 3;
            else if (trend1 < 0 && trend2 < 0) result -= 3;
            
            const avgSum = (recentSum1 + recentSum2 + recentSum3) / 3;
            
            if (avgSum > 17) result += 2;
            else if (avgSum < 10) result -= 2;
        }
        
        const periodNum = parseInt(prevPeriod);
        if (periodNum % 7 === 0) result += 1;
        if (periodNum % 10 === 0) result -= 1;
        
        if (prevSum % 2 === 0 && prevSum2 % 2 === 0) {
            result += 1.5;
        } else if (prevSum % 2 === 1 && prevSum2 % 2 === 1) {
            result -= 1.5;
        }
        
        if (prevSum <= 13 && prevSum2 <= 13) {
            result += 1;
        } else if (prevSum > 13 && prevSum2 > 13) {
            result -= 1;
        }
        
        result = Math.abs(result % 28);
        if (result < 3) result += 4;
        if (result > 25) result -= 4;
        
        const isSmall = result <= 13.5;
        const isEven = Math.round(result) % 2 === 0;
        
        let killGroup;
        if (isSmall && !isEven) killGroup = 'å°å•';
        else if (isSmall && isEven) killGroup = 'å°åŒ';
        else if (!isSmall && !isEven) killGroup = 'å¤§å•';
        else killGroup = 'å¤§åŒ';
        
        return killGroup;
        
    } catch (err) {
        console.error(`æœŸå·ç®—æ³•å¤±è´¥:`, err);
        return 'å°åŒ';
    }
}

// ==================== æ–°å¢å››å¥—ç®—æ³•å®ç° ====================
function getBayesianKillGroup(data, currentPeriod) {
    // åŸæœ‰çš„å¶è´æ–¯ç®—æ³•ä»£ç 
    if (data.length < 3) return 'å°åŒ';
    
    const last3 = data.slice(-3);
    let bayesSum = 0;
    last3.forEach(item => {
        bayesSum += item.sum * 0.6;
    });
    
    const adjustment = currentPeriod ? parseInt(currentPeriod.slice(-1)) * 0.2 : 0;
    const finalValue = (bayesSum / 3) + adjustment;
    
    const size = finalValue <= 13.5 ? 'å°' : 'å¤§';
    const oddEven = Math.round(finalValue) % 2 === 1 ? 'å•' : 'åŒ';
    const bayesianMap = {
        'å°åŒ': 'å¤§å•',
        'å°å•': 'å¤§åŒ',
        'å¤§åŒ': 'å°å•',
        'å¤§å•': 'å°åŒ'
    };
    
    return bayesianMap[size + oddEven] || 'å°åŒ';
}

function getMarkovKillGroup(data, currentPeriod) {
    // åŸæœ‰çš„é©¬å°”ç§‘å¤«ç®—æ³•ä»£ç 
    if (data.length < 4) return 'å°åŒ';
    
    const last4 = data.slice(-4);
    const sums = last4.map(item => item.sum);
    
    // è®¡ç®—è½¬ç§»æ¦‚ç‡
    let transitionSum = 0;
    for (let i = 1; i < sums.length; i++) {
        transitionSum += sums[i] - sums[i-1];
    }
    
    const avgTransition = transitionSum / (sums.length - 1);
    const nextSum = sums[sums.length - 1] + avgTransition;
    
    const size = nextSum <= 13.5 ? 'å°' : 'å¤§';
    const oddEven = Math.round(nextSum) % 2 === 1 ? 'å•' : 'åŒ';
    const markovMap = {
        'å°åŒ': 'å¤§å•',
        'å°å•': 'å¤§åŒ',
        'å¤§åŒ': 'å°å•',
        'å¤§å•': 'å°åŒ'
    };
    
    return markovMap[size + oddEven] || 'å°åŒ';
}

function getFourierKillGroup(data, currentPeriod) {
    // åŸæœ‰çš„å‚…é‡Œå¶ç®—æ³•ä»£ç 
    if (data.length < 5) return 'å°åŒ';
    
    const recent5 = data.slice(-5);
    const sums = recent5.map(item => item.sum);
    
    // ç®€å•å‚…é‡Œå¶å˜æ¢æ¨¡æ‹Ÿ
    let fourierValue = 0;
    for (let i = 0; i < sums.length; i++) {
        fourierValue += sums[i] * Math.sin((i + 1) * Math.PI / sums.length);
    }
    
    const size = Math.abs(fourierValue) <= 13.5 ? 'å°' : 'å¤§';
    const oddEven = Math.round(Math.abs(fourierValue)) % 2 === 1 ? 'å•' : 'åŒ';
    const fourierMap = {
        'å°åŒ': 'å¤§å•',
        'å°å•': 'å¤§åŒ',
        'å¤§åŒ': 'å°å•',
        'å¤§å•': 'å°åŒ'
    };
    
    return fourierMap[size + oddEven] || 'å°åŒ';
}

function getChaosKillGroup(data, currentPeriod) {
    // åŸæœ‰çš„æ··æ²Œç†è®ºç®—æ³•ä»£ç 
    if (data.length < 3) return 'å°åŒ';
    
    const last3 = data.slice(-3);
    const a = last3[0].sum;
    const b = last3[1].sum;
    const c = last3[2].sum;
    
    // é€»è¾‘æ–¯è’‚æ˜ å°„æ¨¡æ‹Ÿæ··æ²Œè¡Œä¸º
    let x = 0.5;
    const r = 3.7 + (a % 10) * 0.1;
    
    for (let i = 0; i < 10; i++) {
        x = r * x * (1 - x);
    }
    
    const chaosValue = x * 28;
    const size = chaosValue <= 13.5 ? 'å°' : 'å¤§';
    const oddEven = Math.round(chaosValue) % 2 === 1 ? 'å•' : 'åŒ';
    const chaosMap = {
        'å°åŒ': 'å¤§å•',
        'å°å•': 'å¤§åŒ',
        'å¤§åŒ': 'å°å•',
        'å¤§å•': 'å°åŒ'
    };
    
    return chaosMap[size + oddEven] || 'å°åŒ';
}

// ==================== ç®—æ³•è·å–æ€ç»„ï¼ˆé›†æˆæ‰€æœ‰ç®—æ³•ï¼‰ ====================
async function getKillGroup(data, currentPeriod) {
    // æ–°å¢cyç®—æ³•åˆ¤æ–­
    if (selectedAlgorithm === 'buyvegetables') {
        return '--'; // cyç®—æ³•ä¸éœ€è¦æ€ç»„
    }
    
    if (selectedAlgorithm === 'kacblic') {
        return await getKacblicKillGroup(currentPeriod);
    }
    
    if (selectedAlgorithm === 'seventyseven') {
        return getSeventySevenKillGroup(data);
    }
    
    const cacheKey = `${selectedAlgorithm}_${data.length}_${currentPeriod}`;
    if(killGroupCache[cacheKey]) return killGroupCache[cacheKey];

    if(data.length === 0) {
        const result = 'å°åŒ';
        killGroupCache[cacheKey] = result;
        return result;
    }

    let killGroupResult = '';

    switch(selectedAlgorithm) {
        case 'classic':
            if (data.length < 3) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const last3 = data.slice(-3);
            const a = last3[0].sum;
            const b = last3[1].sum;
            const c = last3[2].sum;
            
            const step1 = a * 3 + b * 2 + c;
            const step2 = step1 / 3;
            const step3 = step2 * 1.5;
            const step4 = step3 - 8;
            
            const size = step4 <= 13 ? 'å°' : 'å¤§';
            const oddEven = Math.round(step4) % 2 === 1 ? 'å•' : 'åŒ';
            const classicMap = {å°åŒ:'å¤§å•',å°å•:'å¤§åŒ',å¤§åŒ:'å°å•',å¤§å•:'å°åŒ'};
            killGroupResult = classicMap[size + oddEven];
            break;
        
        case 'hotcold':
            if (data.length < 2) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const hotLast = data.slice(-2);
            const h1 = hotLast[0].sum;
            const h2 = hotLast[1].sum;
            
            const hStep1 = h1 + h2;
            const hStep2 = hStep1 * 2;
            const hStep3 = hStep2 + 5;
            const hStep4 = hStep3 / 2;
            const hStep5 = hStep4 * 1.2;
            const hStep6 = hStep5 - 3;
            
            const hSize = hStep6 <= 13 ? 'å°' : 'å¤§';
            const hOddEven = Math.round(hStep6) % 2 === 1 ? 'å•' : 'åŒ';
            const hotcoldMap = {å°åŒ:'å¤§åŒ',å°å•:'å¤§å•',å¤§åŒ:'å°åŒ',å¤§å•:'å°å•'};
            killGroupResult = hotcoldMap[hSize + hOddEven];
            break;
        
        case 'dongsnow':
            if (data.length < 4) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const dongLast = data.slice(-4);
            const d1 = dongLast[0].sum;
            const d2 = dongLast[1].sum;
            const d3 = dongLast[2].sum;
            const d4 = dongLast[3].sum;
            
            const dStep1 = (d1 + d3) * 2;
            const dStep2 = (d2 + d4) * 1.5;
            const dStep3 = (dStep1 + dStep2) / 2;
            const dStep4 = dStep3 - 7;
            
            const dSize = dStep4 <= 13 ? 'å°' : 'å¤§';
            const dOddEven = Math.round(dStep4) % 2 === 1 ? 'å•' : 'åŒ';
            const dongsnowMap = {å°åŒ:'å¤§å•',å°å•:'å¤§åŒ',å¤§åŒ:'å°å•',å¤§å•:'å°åŒ'};
            killGroupResult = dongsnowMap[dSize + dOddEven];
            break;
        
        case 'wave':
            if (data.length < 3) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const waveLast = data.slice(-3);
            const w1 = waveLast[0].sum;
            const w2 = waveLast[1].sum;
            const w3 = waveLast[2].sum;
            
            const wStep1 = (w1 * 0.8) + (w2 * 1.2) + (w3 * 0.5);
            const wStep2 = wStep1 * 1.3;
            const wStep3 = wStep2 - 4;
            
            const wSize = wStep3 <= 13 ? 'å°' : 'å¤§';
            const wOddEven = Math.round(wStep3) % 2 === 1 ? 'å•' : 'åŒ';
            const waveMap = {å°åŒ:'å°å•',å°å•:'å¤§åŒ',å¤§åŒ:'å¤§å•',å¤§å•:'å°åŒ'};
            killGroupResult = waveMap[wSize + wOddEven];
            break;
        
        case 'fibo':
            if (data.length < 2) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const fiboLast = data.slice(-2);
            const f1 = fiboLast[0].sum;
            const f2 = fiboLast[1].sum;
            
            const fiboStep1 = f1 * 1.618 + f2 * 0.618;
            const fiboStep2 = fiboStep1 / 1.618;
            const fiboStep3 = fiboStep2 + 2;
            
            const fiboSize = fiboStep3 <= 13 ? 'å°' : 'å¤§';
            const fiboOddEven = Math.round(fiboStep3) % 2 === 1 ? 'å•' : 'åŒ';
            const fiboMap = {å°åŒ:'å¤§åŒ',å°å•:'å°åŒ',å¤§åŒ:'å¤§å•',å¤§å•:'å°å•'};
            killGroupResult = fiboMap[fiboSize + fiboOddEven];
            break;
        
        case 'extreme':
            if (data.length < 5) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const extremeLast = data.slice(-5);
            const sums = extremeLast.map(item => item.sum);
            const maxSum = Math.max(...sums);
            const minSum = Math.min(...sums);
            
            const extremeStep1 = (maxSum + minSum) / 2;
            const extremeStep2 = extremeStep1 * 1.1;
            
            const extremeSize = extremeStep2 <= 13 ? 'å°' : 'å¤§';
            const extremeOddEven = Math.round(extremeStep2) % 2 === 1 ? 'å•' : 'åŒ';
            const extremeMap = {å°åŒ:'å¤§å•',å°å•:'å°åŒ',å¤§åŒ:'å°å•',å¤§å•:'å¤§åŒ'};
            killGroupResult = extremeMap[extremeSize + extremeOddEven];
            break;
        
        case 'stable':
            if (data.length < 3) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const stableLast = data.slice(-3);
            const s1 = stableLast[0].sum;
            const s2 = stableLast[1].sum;
            const s3 = stableLast[2].sum;
            
            const stableStep1 = (s1 + s2 + s3) / 3;
            const stableStep2 = stableStep1 + 1;
            
            const stableSize = stableStep2 <= 13 ? 'å°' : 'å¤§';
            const stableOddEven = Math.round(stableStep2) % 2 === 1 ? 'å•' : 'åŒ';
            const stableMap = {å°åŒ:'å°å•',å°å•:'å¤§åŒ',å¤§åŒ:'å¤§å•',å¤§å•:'å°åŒ'};
            killGroupResult = stableMap[stableSize + stableOddEven];
            break;
        
        case 'probability':
            if (data.length < 6) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const probLast = data.slice(-6);
            let smallCount = 0;
            let bigCount = 0;
            let singleCount = 0;
            let doubleCount = 0;
            
            probLast.forEach(item => {
                if (item.sum <= 13) smallCount++;
                else bigCount++;
                if (item.sum % 2 === 1) singleCount++;
                else doubleCount++;
            });
            
            const probStep1 = (smallCount - bigCount) * 0.5;
            const probStep2 = (singleCount - doubleCount) * 0.5;
            const probStep3 = 14 + probStep1 + probStep2;
            
            const probSize = probStep3 <= 13 ? 'å°' : 'å¤§';
            const probOddEven = Math.round(probStep3) % 2 === 1 ? 'å•' : 'åŒ';
            const probMap = {å°åŒ:'å¤§åŒ',å°å•:'å¤§å•',å¤§åŒ:'å°åŒ',å¤§å•:'å°å•'};
            killGroupResult = probMap[probSize + probOddEven];
            break;
        
        case 'trend':
            if (data.length < 4) {
                killGroupResult = 'å°åŒ';
                break;
            }
            const trendLast = data.slice(-4);
            const trends = [];
            for (let i = 1; i < trendLast.length; i++) {
                trends.push(trendLast[i].sum - trendLast[i-1].sum);
            }
            const avgTrend = trends.reduce((a,b) => a + b, 0) / trends.length;
            const nextPred = trendLast[trendLast.length-1].sum + avgTrend;
            
            const trendSize = nextPred <= 13 ? 'å°' : 'å¤§';
            const trendOddEven = Math.round(nextPred) % 2 === 1 ? 'å•' : 'åŒ';
            const trendMap = {å°åŒ:'å¤§å•',å°å•:'å¤§åŒ',å¤§åŒ:'å°å•',å¤§å•:'å°åŒ'};
            killGroupResult = trendMap[trendSize + trendOddEven];
            break;
        
        case 'bayesian':
            killGroupResult = getBayesianKillGroup(data, currentPeriod);
            break;
            
        case 'markov':
            killGroupResult = getMarkovKillGroup(data, currentPeriod);
            break;
            
        case 'fourier':
            killGroupResult = getFourierKillGroup(data, currentPeriod);
            break;
            
        case 'chaos':
            killGroupResult = getChaosKillGroup(data, currentPeriod);
            break;
        
        default:
            killGroupResult = 'å°åŒ';
    }

    // é˜²é‡å¤é€»è¾‘
    if (killGroupResult === killGroupHistory.last) {
        killGroupHistory.count++;
        if (killGroupHistory.count >= MAX_SAME_KILL) {
            killGroupResult = killGroupResult === 'å°åŒ' ? 'å¤§å•' : 
                             killGroupResult === 'å¤§å•' ? 'å°åŒ' : 
                             killGroupResult === 'å°å•' ? 'å¤§åŒ' : 'å°å•';
            killGroupHistory.count = 0;
        }
    } else {
        killGroupHistory.count = 1;
    }
    killGroupHistory.last = killGroupResult;

    killGroupCache[cacheKey] = killGroupResult;
    return killGroupResult;
}

// ==================== åˆ¤æ–­ç»“æœ ====================
function judgeResult(actual, killGroup, comboArray) {
    let isComboHit = false;
    
    if (selectedType === 'double') {
        isComboHit = comboArray.includes(actual);
    } else {
        const comboStr = comboArray[0];
        if (comboStr.includes('+')) {
            const parts = comboStr.split('+');
            const fullCombo = parts[0];
            const partial = parts[1];
            
            if (fullCombo === actual) {
                isComboHit = true;
            }
            else if (partial === 'å¤§' && actual.includes('å¤§')) {
                isComboHit = true;
            }
            else if (partial === 'å°' && actual.includes('å°')) {
                isComboHit = true;
            }
            else if (partial === 'å•' && actual.includes('å•')) {
                isComboHit = true;
            }
            else if (partial === 'åŒ' && actual.includes('åŒ')) {
                isComboHit = true;
            }
        }
    }
    
    const isKillHit = actual !== killGroup;
    
    if(isKillHit && isComboHit) return { 
        text: 'ä¸­å¥–', 
        killClass: 'hit-color',
        comboClass: 'hit-color',
        judgeClass: 'hit-color',
        isHit: true
    };
    if(isKillHit) return { 
        text: 'æ€ç»„', 
        killClass: 'hit-color',
        comboClass: '',
        judgeClass: 'hit-color',
        isHit: true
    };
    if(isComboHit) return { 
        text: 'ä¸­å¥–', 
        killClass: '',
        comboClass: 'hit-color',
        judgeClass: 'hit-color',
        isHit: true
    };
    return { 
        text: 'ä¸ä¸­', 
        killClass: '',
        comboClass: '',
        judgeClass: '',
        isHit: false
    };
}

// ==================== è®¡ç®—èƒœç‡ç»Ÿè®¡ ====================
function calculateWinRate() {
    if (detailRecords.length === 0) return null;
    
    const total = detailRecords.length;
    const winCount = detailRecords.filter(r => r.isHit).length;
    
    const winRate = (winCount / total) * 100;
    return {
        winCount,
        total,
        winRate: winRate.toFixed(1)
    };
}

// ==================== æ›´æ–°èƒœç‡ç»Ÿè®¡æ˜¾ç¤º ====================
function updateStatsDisplay() {
    const stats = calculateWinRate();
    const statsSection = document.getElementById('stats-section');
    
    if (stats) {
        statsSection.style.display = 'block';
        document.getElementById('stats-content').textContent = 
            `èƒœç‡ç»Ÿè®¡ï¼š${stats.winCount}/${stats.total} = ${stats.winRate}%`;
        document.getElementById('stats-detail').textContent = 'æ€ä¸­æˆ–ç»„ä¸­éƒ½ç®—ä¸­';
    } else {
        statsSection.style.display = 'none';
    }
}

// ==================== åˆ†æåŠŸèƒ½ ====================
async function analyzeData() {
    const analyzeBtn = document.getElementById('analyze-btn');
    const analyzeText = document.getElementById('analyze-text');
    const analyzeLoading = document.getElementById('analyze-loading');
    
    analyzeBtn.disabled = true;
    analyzeText.textContent = 'åˆ†æä¸­...';
    analyzeLoading.style.display = 'inline-block';
    
    try {
        console.log('å¼€å§‹åˆ†ææ•°æ®ï¼Œç®—æ³•:', selectedAlgorithm);
        
        await fetchAllData();
        console.log('æ•°æ®è·å–å®Œæˆï¼Œå…±', allLotteryData.length, 'æ¡è®°å½•');
        
        if (selectedAlgorithm === 'buyvegetables') {
            // xyç®—æ³•å·²ç»åœ¨selectAlgorithmFromDropdownä¸­å¤„ç†
        } else {
            // å…¶ä»–ç®—æ³•ï¼šè¿›è¡Œé€æœŸåˆ†æ
            detailRecords = [];
            killGroupHistory = { last: '', count: 0 };
            
            if (!totalHitRateStats[selectedAlgorithm]) {
                totalHitRateStats[selectedAlgorithm] = { hit: 0, total: 0 };
            }
            
            for (let i = 0; i < allLotteryData.length; i++) {
                const current = allLotteryData[i];
                const history = allLotteryData.slice(0, i);
                
                const killGroup = await getKillGroup(history, current.period);
                const combo = getComboFromKillGroup(killGroup);
                const judge = judgeResult(current.combo, killGroup, combo);
                
                detailRecords.push({
                    time: current.time,
                    formula: current.formula,
                    killGroup: killGroup,
                    combo: selectedType === 'double' ? combo.join('+') : combo[0],
                    resultText: judge.text,
                    killClass: judge.killClass,
                    comboClass: judge.comboClass,
                    judgeClass: judge.judgeClass,
                    isHit: judge.isHit
                });
                
                if (i === allLotteryData.length - 1) {
                    const nextKillGroup = await getKillGroup(allLotteryData, nextPeriod.toString());
                    const nextCombo = getComboFromKillGroup(nextKillGroup);
                    updateOtherAlgorithmDisplay(nextKillGroup, nextCombo, nextPeriod);
                }
            }
            
            const hitCount = detailRecords.filter(r => r.isHit).length;
            totalHitRateStats[selectedAlgorithm].total = detailRecords.length;
            totalHitRateStats[selectedAlgorithm].hit = hitCount;
            
            localStorage.setItem('totalHitRateStats', JSON.stringify(totalHitRateStats));
            
            const stats = totalHitRateStats[selectedAlgorithm];
            const hitRate = stats.total > 0 ? Math.round((stats.hit / stats.total) * 100) : 0;
            updateCurrentAlgorithmDisplay(selectedAlgorithm, hitRate);
            
            renderFullDetailTable();
            updateStatsDisplay();
        }
        
        console.log('åˆ†æå®Œæˆï¼');
        
    } catch (err) {
        console.error('åˆ†æå¤±è´¥:', err);
        alert(`åˆ†æå¤±è´¥ï¼š${err.message}`);
    } finally {
        analyzeBtn.disabled = false;
        analyzeText.textContent = 'ğŸ” å¼€å§‹é€æœŸåˆ†æ';
        analyzeLoading.style.display = 'none';
    }
}

// ==================== æ›´æ–°å…¶ä»–ç®—æ³•æ˜¾ç¤º ====================
function updateOtherAlgorithmDisplay(killGroup, comboArray, period) {
    document.getElementById('smart-next-period').textContent = period;
    
    if (selectedType === 'double') {
        document.getElementById('smart-prediction-combo').textContent = comboArray.join(' + ');
    } else {
        document.getElementById('smart-prediction-combo').textContent = comboArray[0];
    }
    
    document.getElementById('smart-kill-group').textContent = killGroup;
    
    // ç”Ÿæˆç‰¹ç æ¨è
    let predictionCombosForCodes;
    if (selectedType === 'double') {
        predictionCombosForCodes = comboArray;
    } else {
        const doubleComboMap = {
            'å°å•': ['å¤§å•', 'å¤§åŒ'],
            'å¤§å•': ['å°åŒ', 'å¤§åŒ'],
            'å°åŒ': ['å°å•', 'å¤§å•'],
            'å¤§åŒ': ['å°å•', 'å°åŒ']
        };
        predictionCombosForCodes = doubleComboMap[killGroup] || ['å¤§å•', 'å¤§åŒ'];
    }
    
    const specialCodes = generateSpecialCodes(predictionCombosForCodes, allLotteryData);
    
    const codesDisplay = document.getElementById('special-codes-display');
    codesDisplay.innerHTML = '';
    specialCodes.codes.forEach(code => {
        const codeItem = document.createElement('div');
        codeItem.className = 'special-code-item';
        codeItem.textContent = code;
        codesDisplay.appendChild(codeItem);
    });
    
    document.getElementById('reason-text').textContent = specialCodes.reasons;
}

// ==================== æ¸²æŸ“å®Œæ•´è¯¦æƒ…è¡¨æ ¼ ====================
function renderFullDetailTable() {
    const tbody = document.getElementById('detail-tbody');
    
    if (detailRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="color: #999;">æš‚æ— åˆ†ææ•°æ®</td></tr>';
        return;
    }

    const sorted = [...detailRecords].sort((a,b) => b.time.localeCompare(a.time));
    const displayRecords = sorted.slice(0, DISPLAY_COUNT);
    
    let html = '';

    displayRecords.forEach(record => {
        html += `
        <tr>
            <td>${record.time}</td>
            <td>${record.formula}</td>
            <td class="${record.killClass}">${record.killGroup}</td>
            <td class="${record.comboClass}">${record.combo}</td>
            <td class="${record.judgeClass}">${record.resultText}</td>
        </tr>
        `;
    });

    tbody.innerHTML = html;
    console.log('è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼Œæ˜¾ç¤º', displayRecords.length, 'æœŸæ•°æ®');
}

// ==================== åˆ·æ–°æ•°æ®åŠŸèƒ½ ====================
async function refreshData() {
    const refreshBtn = document.getElementById('refresh-data-btn');
    const headerRefreshBtn = document.getElementById('header-refresh-btn');
    const refreshLoading = document.getElementById('refresh-loading');
    const refreshText = document.getElementById('refresh-text');
    
    refreshBtn.disabled = true;
    headerRefreshBtn.disabled = true;
    refreshText.textContent = 'åˆ·æ–°ä¸­...';
    refreshLoading.style.display = 'inline-block';
    
    try {
        // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è·å–æ•°æ®
        dataCache = null;
        
        await fetchAllData();
        console.log('æ•°æ®åˆ·æ–°å®Œæˆï¼Œå…±', allLotteryData.length, 'æ¡è®°å½•');
        
        if (selectedAlgorithm === 'buyvegetables') {
            // å¦‚æœæ˜¯cyç®—æ³•ï¼Œé‡æ–°è®¡ç®—ç»“æœ
            await loadDataAndShowBuyVegetables();
        } else if (detailRecords.length > 0) {
            // å¦‚æœæ˜¯å…¶ä»–ç®—æ³•ï¼Œé‡æ–°åˆ†æ
            await analyzeData();
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const originalText = refreshText.textContent;
        refreshText.textContent = 'åˆ·æ–°æˆåŠŸï¼';
        setTimeout(() => {
            refreshText.textContent = originalText;
        }, 1000);
        
    } catch (err) {
        console.error('æ•°æ®åˆ·æ–°å¤±è´¥:', err);
        refreshText.textContent = 'åˆ·æ–°å¤±è´¥';
        setTimeout(() => {
            refreshText.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
        }, 1000);
    } finally {
        refreshBtn.disabled = false;
        headerRefreshBtn.disabled = false;
        refreshText.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
        refreshLoading.style.display = 'none';
    }
}

// ==================== é¡µé¢åˆå§‹åŒ– ====================
window.onload = function() {
    // ç»‘å®šäº‹ä»¶
    document.getElementById('algorithm-select').addEventListener('change', function(e) {
        selectAlgorithmFromDropdown(e.target.value);
    });
    
    document.getElementById('type-select').addEventListener('change', function(e) {
        selectTypeFromDropdown(e.target.value);
    });
    
    document.getElementById('analyze-btn').addEventListener('click', function() {
        analyzeData();
    });
    
    document.getElementById('refresh-data-btn').addEventListener('click', function() {
        refreshData();
    });
    
    document.getElementById('enhance-double-btn').addEventListener('click', function() {
        showEnhanceDouble();
    });
    
    document.getElementById('header-refresh-btn').addEventListener('click', function() {
        refreshData();
    });
    
    document.getElementById('buyvegetables-refresh-btn').addEventListener('click', function() {
        loadDataAndShowBuyVegetables();
    });
    
    // å¼¹çª—å…³é—­æŒ‰é’®ï¼ˆå¼ºåŒ–åŒç»„å¼¹çª—ä¼šåœ¨showEnhanceDoubleä¸­åŠ¨æ€åˆ›å»ºï¼‰
    
    // åˆå§‹åŒ–ç»Ÿè®¡
    totalHitRateStats = initTotalHitRateStats();
    document.getElementById('algorithm-select').value = selectedAlgorithm;
    document.getElementById('type-select').value = selectedType;
    updateCurrentAlgorithmDisplay(selectedAlgorithm, 0);
    
    // åˆå§‹æ˜¾ç¤º
    selectAlgorithmFromDropdown(selectedAlgorithm);
    
    console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½å·²é›†æˆ');
};
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TXDiPCh9eNgRP8RDQSR2xeo7Q4epNwfN7RWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"d1cfa5cc475e492e83c89755e7071077","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
  </html>
